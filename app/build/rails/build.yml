apiVersion: v1
kind: Pod
metadata:
  name: rails-build-{{ app_env }}
  labels:
    name: rails-build-{{ app_env }}
spec: 
  restartPolicy: Never
  containers:
    - image: gcr.io/kaniko-project/executor:latest
      name: kaniko
      args:
        - --destination={{ rails_repo_url }}
        - --context=/rails/cloud/build/rails
        - --dockerfile=/Dockerfile
        - --build-arg=RAILS_ENV={{ app_env }}
      env:
        - name: RAILS_ENV
          value: development
      volumeMounts:
        - mountPath: /rails
          name: rails
        - mountPath: /kaniko/.docker/config.json
          name: docker
  volumes:
    - name: rails
      hostPath:
        path: {{ app_path }}
    - name: docker
      hostPath:
        path: {{ user_auth_path }}
